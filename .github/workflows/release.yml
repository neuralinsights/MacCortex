name: MacCortex Release CI/CD

# MacCortex Phase 0.5 - Day 5
# GitHub Actions è‡ªåŠ¨æ„å»ºã€ç­¾åã€å…¬è¯å’Œå‘å¸ƒæµç¨‹
# åˆ›å»ºæ—¶é—´: 2026-01-20

on:
  push:
    tags:
      - 'v*.*.*'      # è§¦å‘æ¡ä»¶: æ¨é€ç‰ˆæœ¬æ ‡ç­¾ (ä¾‹å¦‚: v0.5.0)
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

env:
  APP_NAME: MacCortex
  SCHEME: MacCortex
  CONFIGURATION: Release

jobs:
  build-and-release:
    name: æ„å»ºã€ç­¾åã€å…¬è¯å’Œå‘å¸ƒ
    runs-on: macos-14  # ä½¿ç”¨ macOS 14 (Sonoma)

    steps:
      # ==========================================
      # 1. ä»£ç æ£€å‡º
      # ==========================================
      - name: æ£€å‡ºä»£ç 
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²è®°å½•ï¼ˆç”¨äºç‰ˆæœ¬å·ï¼‰

      # ==========================================
      # 2. è®¾ç½® Xcode ç¯å¢ƒ
      # ==========================================
      - name: é€‰æ‹© Xcode ç‰ˆæœ¬
        run: sudo xcode-select -s /Applications/Xcode_15.2.app/Contents/Developer

      - name: éªŒè¯ Xcode é…ç½®
        run: |
          xcodebuild -version
          swift --version

      # ==========================================
      # 3. æ¢å¤ SPM ä¾èµ–
      # ==========================================
      - name: ç¼“å­˜ SPM ä¾èµ–
        uses: actions/cache@v4
        with:
          path: |
            .build
            ~/Library/Developer/Xcode/DerivedData
          key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-spm-

      - name: è§£æä¾èµ–
        run: swift package resolve

      # ==========================================
      # 4. å¯¼å…¥ä»£ç ç­¾åè¯ä¹¦
      # ==========================================
      - name: å¯¼å…¥ Developer ID è¯ä¹¦
        env:
          # GitHub Secrets éœ€è¦é…ç½®:
          # - DEVELOPER_ID_CERT_BASE64: Developer ID è¯ä¹¦ (.p12 æ–‡ä»¶ base64 ç¼–ç )
          # - DEVELOPER_ID_CERT_PASSWORD: .p12 æ–‡ä»¶å¯†ç 
          CERT_BASE64: ${{ secrets.DEVELOPER_ID_CERT_BASE64 }}
          CERT_PASSWORD: ${{ secrets.DEVELOPER_ID_CERT_PASSWORD }}
        run: |
          echo "å¯¼å…¥ä»£ç ç­¾åè¯ä¹¦åˆ° Keychain..."

          # åˆ›å»ºä¸´æ—¶ keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)

          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # å¯¼å…¥è¯ä¹¦
          echo "$CERT_BASE64" | base64 --decode > certificate.p12
          security import certificate.p12 \
            -k "$KEYCHAIN_PATH" \
            -P "$CERT_PASSWORD" \
            -T /usr/bin/codesign \
            -T /usr/bin/productsign

          # è®¾ç½®ä¸ºé»˜è®¤ keychain
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"

          # éªŒè¯è¯ä¹¦
          security find-identity -v -p codesigning

          # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
          rm -f certificate.p12

      # ==========================================
      # 5. æ„å»ºåº”ç”¨
      # ==========================================
      - name: æ„å»º macOS åº”ç”¨
        run: |
          echo "å¼€å§‹æ„å»º $APP_NAME..."

          # ä½¿ç”¨ xcodebuild æ„å»ºï¼ˆPhase 1 ä¼šåˆ‡æ¢åˆ° SPMï¼‰
          # å½“å‰ä½¿ç”¨å ä½ç¬¦ï¼Œå®é™…éœ€è¦ Xcode é¡¹ç›®æ–‡ä»¶

          # åˆ›å»ºä¸´æ—¶æ„å»ºç›®å½•
          mkdir -p build

          # TODO: å®é™…æ„å»ºå‘½ä»¤ï¼ˆéœ€è¦ Xcode é¡¹ç›®ï¼‰
          # xcodebuild \
          #   -project MacCortex.xcodeproj \
          #   -scheme "$SCHEME" \
          #   -configuration "$CONFIGURATION" \
          #   -derivedDataPath ./DerivedData \
          #   build

          echo "âš ï¸  æ„å»ºæ­¥éª¤å¾… Xcode é¡¹ç›®åˆ›å»ºåå®Œå–„"

      # ==========================================
      # 6. ä»£ç ç­¾å
      # ==========================================
      - name: ç­¾ååº”ç”¨
        env:
          DEVELOPER_ID: ${{ secrets.DEVELOPER_ID_NAME }}
        run: |
          echo "å¼€å§‹ç­¾åæµç¨‹..."

          # ä½¿ç”¨æˆ‘ä»¬çš„ç­¾åè„šæœ¬
          # ./Scripts/sign.sh build/$APP_NAME.app

          echo "âš ï¸  ç­¾åæ­¥éª¤å¾…åº”ç”¨æ„å»ºå®Œæˆåæ‰§è¡Œ"

      # ==========================================
      # 7. å…¬è¯åº”ç”¨
      # ==========================================
      - name: å…¬è¯åº”ç”¨
        env:
          # GitHub Secrets éœ€è¦é…ç½®:
          # - APPLE_ID: Apple ID é‚®ç®±
          # - APPLE_TEAM_ID: Team ID
          # - APPLE_APP_PASSWORD: App-Specific Password
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          echo "å¼€å§‹å…¬è¯æµç¨‹..."

          # åˆ›å»º ZIP ç”¨äºå…¬è¯
          # ditto -c -k --keepParent build/$APP_NAME.app build/$APP_NAME.zip

          # æäº¤å…¬è¯
          # xcrun notarytool submit build/$APP_NAME.zip \
          #   --apple-id "$APPLE_ID" \
          #   --team-id "$APPLE_TEAM_ID" \
          #   --password "$APPLE_APP_PASSWORD" \
          #   --wait

          # Staple ç¥¨æ®
          # xcrun stapler staple build/$APP_NAME.app

          echo "âš ï¸  å…¬è¯æ­¥éª¤å¾…åº”ç”¨ç­¾åå®Œæˆåæ‰§è¡Œ"

      # ==========================================
      # 8. åˆ›å»º DMG
      # ==========================================
      - name: åˆ›å»º DMG å®‰è£…åŒ…
        run: |
          echo "åˆ›å»º DMG..."

          # æå–ç‰ˆæœ¬å·
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          # ä½¿ç”¨æˆ‘ä»¬çš„ DMG è„šæœ¬
          # export VERSION=$VERSION
          # ./Scripts/build-dmg.sh build/$APP_NAME.app

          echo "âš ï¸  DMG åˆ›å»ºå¾…åº”ç”¨æ„å»ºå®Œæˆåæ‰§è¡Œ"

      # ==========================================
      # 9. ç”Ÿæˆ Release Notes
      # ==========================================
      - name: ç”Ÿæˆ Release Notes
        id: release_notes
        run: |
          # è·å–ä¸Šä¸€ä¸ª tag
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")

          if [ -z "$PREVIOUS_TAG" ]; then
            echo "é¦–æ¬¡å‘å¸ƒ"
            RELEASE_NOTES="MacCortex é¦–ä¸ªå…¬å¼€ç‰ˆæœ¬"
          else
            echo "ç”Ÿæˆ $PREVIOUS_TAG..HEAD çš„å˜æ›´æ—¥å¿—..."
            RELEASE_NOTES=$(git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s" --no-merges)
          fi

          # è¾“å‡ºåˆ° GitHub Actions
          echo "RELEASE_NOTES<<EOF" >> $GITHUB_ENV
          echo "$RELEASE_NOTES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      # ==========================================
      # 10. åˆ›å»º GitHub Release
      # ==========================================
      - name: åˆ›å»º GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: MacCortex ${{ env.VERSION }}
          body: |
            ## MacCortex ${{ env.VERSION }}

            ### å˜æ›´å†…å®¹
            ${{ env.RELEASE_NOTES }}

            ### å®‰è£…è¯´æ˜
            1. ä¸‹è½½ `MacCortex-v${{ env.VERSION }}.dmg`
            2. åŒå‡» DMG æ–‡ä»¶
            3. å°† MacCortex.app æ‹–åˆ° Applications æ–‡ä»¶å¤¹
            4. é¦–æ¬¡å¯åŠ¨æ—¶ï¼ŒæŒ‰ç…§å¼•å¯¼æˆäºˆ Full Disk Access æƒé™

            ### ç³»ç»Ÿè¦æ±‚
            - macOS 14.0 (Sonoma) æˆ–æ›´é«˜ç‰ˆæœ¬
            - Apple Silicon æˆ– Intel å¤„ç†å™¨

            ### éªŒè¯ç­¾å
            ```bash
            spctl --assess --type execute /Applications/MacCortex.app
            codesign -dv --verbose=4 /Applications/MacCortex.app
            ```

            ---

            ğŸ¤– ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå’Œå‘å¸ƒ
          files: |
            build/MacCortex-v${{ env.VERSION }}.dmg
          draft: true  # åˆ›å»ºä¸ºè‰ç¨¿ï¼Œæ‰‹åŠ¨å®¡æ ¸åå‘å¸ƒ
          prerelease: ${{ contains(github.ref, 'alpha') || contains(github.ref, 'beta') }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # ==========================================
      # 11. ä¸Šä¼ æ„å»ºäº§ç‰©
      # ==========================================
      - name: ä¸Šä¼ æ„å»ºäº§ç‰©
        uses: actions/upload-artifact@v4
        with:
          name: MacCortex-${{ env.VERSION }}
          path: |
            build/MacCortex.app
            build/MacCortex-v${{ env.VERSION }}.dmg
          retention-days: 30

      # ==========================================
      # 12. æ¸…ç†
      # ==========================================
      - name: æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        if: always()
        run: |
          # åˆ é™¤ä¸´æ—¶ keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/app-signing.keychain-db
          if [ -f "$KEYCHAIN_PATH" ]; then
            security delete-keychain "$KEYCHAIN_PATH"
          fi

          # æ¸…ç†æ•æ„Ÿä¿¡æ¯
          rm -f certificate.p12

# ==========================================
# GitHub Secrets é…ç½®æ¸…å•
# ==========================================
#
# åœ¨ GitHub ä»“åº“è®¾ç½®ä¸­é…ç½®ä»¥ä¸‹ Secrets:
# (Settings â†’ Secrets and variables â†’ Actions â†’ New repository secret)
#
# 1. DEVELOPER_ID_CERT_BASE64
#    - Developer ID è¯ä¹¦ (.p12 æ–‡ä»¶) çš„ base64 ç¼–ç 
#    - ç”Ÿæˆæ–¹æ³•:
#      1) ä» Keychain å¯¼å‡ºè¯ä¹¦: Keychain Access â†’ Developer ID Application â†’ Export â†’ .p12
#      2) base64 ç¼–ç : base64 -i certificate.p12 | pbcopy
#      3) ç²˜è´´åˆ° GitHub Secret
#
# 2. DEVELOPER_ID_CERT_PASSWORD
#    - å¯¼å‡º .p12 æ—¶è®¾ç½®çš„å¯†ç 
#
# 3. DEVELOPER_ID_NAME
#    - ç­¾åèº«ä»½å®Œæ•´åç§° (ä¾‹å¦‚: "Developer ID Application: Your Name (TEAM_ID)")
#    - æŸ¥è¯¢æ–¹æ³•: security find-identity -v -p codesigning
#
# 4. APPLE_ID
#    - Apple ID é‚®ç®±åœ°å€
#
# 5. APPLE_TEAM_ID
#    - Team ID (10 ä¸ªå­—ç¬¦)
#    - æŸ¥è¯¢æ–¹æ³•: è®¿é—® https://developer.apple.com/account â†’ Membership
#
# 6. APPLE_APP_PASSWORD
#    - App-Specific Password (ç”¨äºå…¬è¯)
#    - ç”Ÿæˆæ–¹æ³•: https://appleid.apple.com/account/manage â†’ App-Specific Passwords
#
# ==========================================
