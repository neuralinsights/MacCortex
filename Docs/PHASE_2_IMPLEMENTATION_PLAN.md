# MacCortex Phase 2 å®æ–½è®¡åˆ’

**ç‰ˆæœ¬**: v1.0
**åˆ›å»ºæ—¶é—´**: 2026-01-21
**çŠ¶æ€**: è§„åˆ’ä¸­
**å‰ç½®æ¡ä»¶**: Phase 1.5 å·²å®Œæˆ âœ…

---

## æ‰§è¡Œæ‘˜è¦

Phase 2 æ˜¯ MacCortex çš„ **Desktop GUI + é«˜çº§åŠŸèƒ½å¼€å‘é˜¶æ®µ**ï¼Œç›®æ ‡æ˜¯æ„å»ºä¸€ä¸ªç°ä»£åŒ–çš„ macOS åŸç”Ÿåº”ç”¨ï¼Œæä¾›"éšå½¢ AI"ç”¨æˆ·ä½“éªŒï¼ŒåŒæ—¶å¤ç”¨ Phase 1.5 çš„å®‰å…¨åŸºç¡€è®¾æ–½ã€‚

**æ ¸å¿ƒç›®æ ‡**:
1. âœ… Desktop GUIï¼ˆSwiftUI + Observation Frameworkï¼‰
2. âœ… æµ®åŠ¨å·¥å…·æ ï¼ˆApple Intelligence é£æ ¼ï¼‰
3. âœ… æ™ºèƒ½åœºæ™¯è¯†åˆ«ï¼ˆè‡ªåŠ¨æ£€æµ‹ç”¨æˆ·æ„å›¾ï¼‰
4. âœ… æ¸è¿›å¼ä¿¡ä»»æœºåˆ¶ï¼ˆRisk Level 0-3ï¼‰
5. âœ… ä¸€é”®æ’¤é”€ï¼ˆ7 å¤©å†…å¯å›æ»šï¼‰
6. âœ… Phase 1.5 å®‰å…¨é›†æˆï¼ˆå®¡è®¡æ—¥å¿—ã€é€Ÿç‡é™åˆ¶ç­‰ï¼‰

**å·¥æœŸ**: 3 å‘¨ï¼ˆ15 ä¸ªå·¥ä½œæ—¥ï¼‰
**éªŒæ”¶æ ‡å‡†**: 6 é¡¹ P0 é˜»å¡æ€§æ ‡å‡†å¿…é¡»å…¨éƒ¨é€šè¿‡
**ç”¨æˆ·ä½“éªŒè¯„åˆ†ç›®æ ‡**: 7/10 â†’ 9/10 (+28.6%)

---

## èƒŒæ™¯ï¼šPhase 1.5 å®ŒæˆçŠ¶æ€

### å·²æœ‰åŸºç¡€è®¾æ–½

**å®‰å…¨æ¨¡å—** (Phase 1.5 âœ…):
- âœ… 5 å±‚ Prompt Injection é˜²æŠ¤ï¼ˆ87% é˜²å¾¡ç‡ï¼‰
- âœ… å®¡è®¡æ—¥å¿—ç³»ç»Ÿï¼ˆPII è„±æ• + GDPR åˆè§„ï¼‰
- âœ… è¾“å…¥éªŒè¯ç³»ç»Ÿï¼ˆå‚æ•°ç™½åå•ï¼‰
- âœ… é€Ÿç‡é™åˆ¶ç³»ç»Ÿï¼ˆ60/min + 1000/hourï¼‰
- âœ… è¾“å‡ºéªŒè¯ç³»ç»Ÿï¼ˆå‡­è¯æ¸…ç†ï¼‰

**åç«¯æœåŠ¡** (Phase 1 âœ…):
- âœ… FastAPI REST APIï¼ˆ5 ä¸ª Patternï¼‰
- âœ… MLX/Ollama é›†æˆï¼ˆApple Silicon ä¼˜åŒ–ï¼‰
- âœ… ç‰ˆæƒä¿æŠ¤ç³»ç»Ÿï¼ˆæ°´å° + å®¡è®¡ï¼‰

**ç­¾åä¸åˆ†å‘** (Phase 0.5 âœ…):
- âœ… Developer ID ç­¾å + Notarization
- âœ… Hardened Runtime Entitlements
- âœ… Sparkle 2 è‡ªåŠ¨æ›´æ–°

### Phase 2 çš„æŒ‘æˆ˜

1. **UX è®¾è®¡**: ä»"CLI å·¥ç¨‹å¸ˆå·¥å…·"åˆ°"éšå½¢ AI åŠ©æ‰‹"
2. **SwiftUI ç°ä»£åŒ–**: ä½¿ç”¨ Observation Frameworkï¼ˆiOS 17+/macOS 14+ï¼‰
3. **åœºæ™¯è¯†åˆ«**: æ™ºèƒ½æ£€æµ‹ç”¨æˆ·æ„å›¾ï¼ˆæ–‡æœ¬é€‰æ‹©ã€æ–‡ä»¶æ‹–æ‹½ç­‰ï¼‰
4. **ä¿¡ä»»æœºåˆ¶**: æ¸è¿›å¼é£é™©è¯„ä¼°ï¼ˆR0 â†’ R3ï¼‰
5. **æ’¤é”€ç³»ç»Ÿ**: 7 å¤©å†…ä¸€é”®å›æ»šï¼ˆæ–‡ä»¶ç‰ˆæœ¬ç®¡ç†ï¼‰
6. **å®‰å…¨é›†æˆ**: å‰ç«¯è°ƒç”¨ Phase 1.5 å®‰å…¨ API

---

## Phase 2 æ ¸å¿ƒæ¶æ„

### æŠ€æœ¯æ ˆé€‰æ‹©

**Frontendï¼ˆmacOS åº”ç”¨ï¼‰**:
- **GUI æ¡†æ¶**: SwiftUIï¼ˆmacOS 14+ï¼‰
- **çŠ¶æ€ç®¡ç†**: Observation Frameworkï¼ˆæ›¿ä»£ @StateObject/@ObservedObjectï¼‰
- **ç½‘ç»œ**: URLSession + async/await
- **æŒä¹…åŒ–**: SwiftDataï¼ˆæ›¿ä»£ Core Dataï¼‰
- **æƒé™ç®¡ç†**: FullDiskAccess.swift + TCCï¼ˆå·²æœ‰ï¼‰

**åç«¯é›†æˆ**:
- **é€šä¿¡åè®®**: REST APIï¼ˆFastAPIï¼‰
- **å®‰å…¨è°ƒç”¨**: é›†æˆ Phase 1.5 å®¡è®¡æ—¥å¿— + é€Ÿç‡é™åˆ¶
- **é”™è¯¯å¤„ç†**: ç»Ÿä¸€é”™è¯¯å¤„ç† + ç”¨æˆ·å‹å¥½æç¤º

### åº”ç”¨æ¶æ„

```
MacCortex.app
â”œâ”€â”€ App Layerï¼ˆåº”ç”¨å±‚ï¼‰
â”‚   â”œâ”€â”€ MacCortexApp.swift         # åº”ç”¨å…¥å£ï¼ˆ@mainï¼‰
â”‚   â”œâ”€â”€ AppState.swift              # å…¨å±€çŠ¶æ€ï¼ˆObservationï¼‰
â”‚   â””â”€â”€ SceneDelegate.swift         # åœºæ™¯ç®¡ç†
â”‚
â”œâ”€â”€ UI Layerï¼ˆç•Œé¢å±‚ï¼‰
â”‚   â”œâ”€â”€ Views/
â”‚   â”‚   â”œâ”€â”€ FloatingToolbar.swift  # æµ®åŠ¨å·¥å…·æ ï¼ˆä¸»ç•Œé¢ï¼‰
â”‚   â”‚   â”œâ”€â”€ PatternPicker.swift    # Pattern é€‰æ‹©å™¨
â”‚   â”‚   â”œâ”€â”€ ResultView.swift       # ç»“æœå±•ç¤º
â”‚   â”‚   â”œâ”€â”€ HistoryView.swift      # å†å²è®°å½•
â”‚   â”‚   â””â”€â”€ SettingsView.swift     # è®¾ç½®ç•Œé¢
â”‚   â””â”€â”€ Components/
â”‚       â”œâ”€â”€ RiskBadge.swift        # é£é™©ç­‰çº§æ ‡è¯†
â”‚       â”œâ”€â”€ ProgressIndicator.swift # è¿›åº¦æŒ‡ç¤ºå™¨
â”‚       â””â”€â”€ UndoButton.swift       # æ’¤é”€æŒ‰é’®
â”‚
â”œâ”€â”€ Business Logic Layerï¼ˆä¸šåŠ¡é€»è¾‘å±‚ï¼‰
â”‚   â”œâ”€â”€ Services/
â”‚   â”‚   â”œâ”€â”€ PatternService.swift   # Pattern æ‰§è¡ŒæœåŠ¡
â”‚   â”‚   â”œâ”€â”€ SceneDetector.swift    # åœºæ™¯è¯†åˆ«æœåŠ¡
â”‚   â”‚   â”œâ”€â”€ TrustEngine.swift      # æ¸è¿›å¼ä¿¡ä»»å¼•æ“
â”‚   â”‚   â””â”€â”€ UndoManager.swift      # æ’¤é”€ç®¡ç†å™¨
â”‚   â””â”€â”€ Models/
â”‚       â”œâ”€â”€ Pattern.swift          # Pattern æ¨¡å‹
â”‚       â”œâ”€â”€ Task.swift             # ä»»åŠ¡æ¨¡å‹
â”‚       â”œâ”€â”€ RiskLevel.swift        # é£é™©ç­‰çº§
â”‚       â””â”€â”€ UndoSnapshot.swift     # æ’¤é”€å¿«ç…§
â”‚
â”œâ”€â”€ Data Layerï¼ˆæ•°æ®å±‚ï¼‰
â”‚   â”œâ”€â”€ Repositories/
â”‚   â”‚   â”œâ”€â”€ TaskRepository.swift   # ä»»åŠ¡æ•°æ®ä»“åº“
â”‚   â”‚   â””â”€â”€ HistoryRepository.swift # å†å²è®°å½•ä»“åº“
â”‚   â””â”€â”€ SwiftData/
â”‚       â”œâ”€â”€ Schema.swift           # SwiftData Schema
â”‚       â””â”€â”€ Migration.swift        # æ•°æ®è¿ç§»
â”‚
â”œâ”€â”€ Network Layerï¼ˆç½‘ç»œå±‚ï¼‰
â”‚   â”œâ”€â”€ APIClient.swift            # API å®¢æˆ·ç«¯
â”‚   â”œâ”€â”€ Endpoints.swift            # API ç«¯ç‚¹å®šä¹‰
â”‚   â””â”€â”€ SecurityInterceptor.swift  # å®‰å…¨æ‹¦æˆªå™¨ï¼ˆé›†æˆ Phase 1.5ï¼‰
â”‚
â””â”€â”€ System Layerï¼ˆç³»ç»Ÿå±‚ï¼‰
    â”œâ”€â”€ Permissions/
    â”‚   â”œâ”€â”€ FullDiskAccessManager.swift
    â”‚   â””â”€â”€ NotificationsManager.swift
    â””â”€â”€ Utilities/
        â”œâ”€â”€ Logger.swift           # æ—¥å¿—å·¥å…·
        â””â”€â”€ FileManager+Extensions.swift
```

---

## Week 1: åŸºç¡€ GUI æ¡†æ¶ï¼ˆDay 1-5ï¼‰

### Day 1-2: SwiftUI é¡¹ç›®éª¨æ¶

**ä»»åŠ¡**:
- [ ] åˆ›å»º Xcode é¡¹ç›®ï¼ˆmacOS Appï¼ŒSwiftUI + Swift 6ï¼‰
- [ ] é…ç½® Observation Framework
- [ ] è®¾ç½® SwiftData Schema
- [ ] é›†æˆ Phase 0.5 ç­¾åé…ç½®

**äº¤ä»˜ç‰©**: å¯è¿è¡Œçš„ç©ºç™½åº”ç”¨ + AppState

**æ ¸å¿ƒä»£ç **:
```swift
// MacCortexApp.swift
import SwiftUI

@main
struct MacCortexApp: App {
    @State private var appState = AppState()

    var body: some Scene {
        WindowGroup {
            ContentView()
                .environment(appState)
        }
        .commands {
            CommandGroup(replacing: .newItem) {}
        }
    }
}

// AppState.swift (Observation Framework)
import Observation
import Foundation

@Observable
class AppState {
    var selectedPattern: Pattern?
    var currentTask: Task?
    var history: [Task] = []
    var isProcessing = false

    // Phase 1.5 å®‰å…¨é›†æˆ
    var auditLogger: AuditLogger
    var rateLimiter: RateLimiter

    init() {
        self.auditLogger = AuditLogger()
        self.rateLimiter = RateLimiter()
    }
}
```

**éªŒæ”¶**:
```bash
# æ„å»ºæˆåŠŸ
xcodebuild -scheme MacCortex -configuration Debug build

# ç­¾åéªŒè¯
codesign -dv --verbose=4 build/Debug/MacCortex.app
```

---

### Day 3-4: æµ®åŠ¨å·¥å…·æ  UI

**ä»»åŠ¡**:
- [ ] è®¾è®¡æµ®åŠ¨å·¥å…·æ ï¼ˆå‚è€ƒ Apple Intelligence é£æ ¼ï¼‰
- [ ] å®ç° Pattern é€‰æ‹©å™¨ï¼ˆ5 ä¸ª Patternï¼‰
- [ ] æ·»åŠ å¿«æ·é”®æ”¯æŒï¼ˆâŒ˜+Shift+Spaceï¼‰
- [ ] å®ç°çª—å£ç½®é¡¶ä¸é€æ˜æ•ˆæœ

**äº¤ä»˜ç‰©**: FloatingToolbar.swift

**æ ¸å¿ƒ UI è®¾è®¡**:
```swift
// FloatingToolbar.swift
import SwiftUI

struct FloatingToolbar: View {
    @Environment(AppState.self) private var appState
    @State private var isExpanded = false

    var body: some View {
        VStack(spacing: 0) {
            // é¡¶éƒ¨æ‰‹æŸ„
            Handle()

            // Pattern é€‰æ‹©å™¨
            if isExpanded {
                PatternPicker(selection: $appState.selectedPattern)
                    .transition(.move(edge: .top).combined(with: .opacity))
            }

            // ä¸»æ“ä½œæŒ‰é’®
            ActionButton(
                pattern: appState.selectedPattern,
                action: { await executePattern() }
            )
        }
        .frame(width: 320)
        .background(.ultraThinMaterial)
        .clipShape(RoundedRectangle(cornerRadius: 16))
        .shadow(color: .black.opacity(0.1), radius: 20)
        .onAppear {
            // çª—å£ç½®é¡¶
            NSApp.windows.first?.level = .floating
        }
    }

    private func executePattern() async {
        // è°ƒç”¨ Phase 1.5 å®‰å…¨ API
        guard await appState.rateLimiter.checkLimit() else {
            showRateLimitError()
            return
        }

        // æ‰§è¡Œ Pattern
        await appState.executePattern()
    }
}
```

**éªŒæ”¶**:
- âœ… å·¥å…·æ æ˜¾ç¤ºæ­£å¸¸ï¼ˆ320px å®½åº¦ï¼ŒåŠé€æ˜æè´¨ï¼‰
- âœ… å¿«æ·é”® âŒ˜+Shift+Space è§¦å‘
- âœ… çª—å£ç½®é¡¶ï¼ˆlevel = .floatingï¼‰
- âœ… åŠ¨ç”»æµç•…ï¼ˆ60fpsï¼‰

---

### Day 5: ç½‘ç»œå±‚ + Phase 1.5 é›†æˆ

**ä»»åŠ¡**:
- [ ] åˆ›å»º APIClientï¼ˆURLSession + async/awaitï¼‰
- [ ] å®ç° SecurityInterceptorï¼ˆé›†æˆå®¡è®¡æ—¥å¿—ã€é€Ÿç‡é™åˆ¶ï¼‰
- [ ] è¿æ¥ FastAPI Backend
- [ ] é”™è¯¯å¤„ç†ä¸é‡è¯•æœºåˆ¶

**äº¤ä»˜ç‰©**: APIClient.swift + SecurityInterceptor.swift

**æ ¸å¿ƒä»£ç **:
```swift
// APIClient.swift
import Foundation

actor APIClient {
    private let baseURL = URL(string: "http://localhost:8000")!
    private let session = URLSession.shared
    private let interceptor: SecurityInterceptor

    init(interceptor: SecurityInterceptor) {
        self.interceptor = interceptor
    }

    func executePattern(
        _ pattern: Pattern,
        text: String,
        parameters: [String: Any]
    ) async throws -> PatternResult {
        // Phase 1.5 å®‰å…¨æ‹¦æˆª
        try await interceptor.preRequest(pattern: pattern, text: text)

        // æ„å»ºè¯·æ±‚
        var request = URLRequest(url: baseURL.appendingPathComponent("/execute"))
        request.httpMethod = "POST"
        request.setValue("application/json", forHTTPHeaderField: "Content-Type")

        let body: [String: Any] = [
            "pattern_id": pattern.id,
            "text": text,
            "parameters": parameters
        ]
        request.httpBody = try JSONSerialization.data(withJSONObject: body)

        // å‘é€è¯·æ±‚
        let (data, response) = try await session.data(for: request)

        // Phase 1.5 å®¡è®¡æ—¥å¿—
        await interceptor.postRequest(response: response, data: data)

        // è§£æå“åº”
        guard let httpResponse = response as? HTTPURLResponse,
              httpResponse.statusCode == 200 else {
            throw APIError.invalidResponse
        }

        return try JSONDecoder().decode(PatternResult.self, from: data)
    }
}

// SecurityInterceptor.swift
actor SecurityInterceptor {
    private let auditLogger: AuditLogger
    private let rateLimiter: RateLimiter

    func preRequest(pattern: Pattern, text: String) async throws {
        // é€Ÿç‡é™åˆ¶æ£€æŸ¥
        guard await rateLimiter.checkLimit() else {
            throw SecurityError.rateLimitExceeded
        }

        // å®¡è®¡æ—¥å¿—ï¼ˆè¯·æ±‚å‰ï¼‰
        await auditLogger.logRequest(
            pattern: pattern.id,
            textLength: text.count
        )
    }

    func postRequest(response: URLResponse, data: Data) async {
        // å®¡è®¡æ—¥å¿—ï¼ˆè¯·æ±‚åï¼‰
        await auditLogger.logResponse(
            statusCode: (response as? HTTPURLResponse)?.statusCode ?? 0,
            dataSize: data.count
        )
    }
}
```

**éªŒæ”¶**:
```bash
# å¯åŠ¨ Backend
cd Backend && source .venv/bin/activate && python -m uvicorn src.main:app --reload

# æµ‹è¯• API è¿æ¥
curl -X POST http://localhost:8000/execute -d '{
  "pattern_id": "summarize",
  "text": "Test text",
  "parameters": {}
}'

# éªŒè¯å®¡è®¡æ—¥å¿—
cat Backend/logs/audit-$(date +%Y-%m-%d).jsonl | jq .
```

---

## Week 2: åœºæ™¯è¯†åˆ« + ä¿¡ä»»æœºåˆ¶ï¼ˆDay 6-10ï¼‰

### Day 6-7: æ™ºèƒ½åœºæ™¯è¯†åˆ«

**ä»»åŠ¡**:
- [ ] å®ç° SceneDetectorï¼ˆæ–‡æœ¬é€‰æ‹©ã€æ–‡ä»¶æ‹–æ‹½ã€å‰ªè´´æ¿æ£€æµ‹ï¼‰
- [ ] è‡ªåŠ¨æ¨è Patternï¼ˆåŸºäºåœºæ™¯ï¼‰
- [ ] é›†æˆ macOS Accessibility API
- [ ] å®æ—¶åœºæ™¯ç›‘å¬ï¼ˆä¸å½±å“æ€§èƒ½ï¼‰

**äº¤ä»˜ç‰©**: SceneDetector.swift

**æ ¸å¿ƒåŠŸèƒ½**:
```swift
// SceneDetector.swift
import AppKit
import Accessibility

@Observable
class SceneDetector {
    var currentScene: Scene?
    var recommendedPattern: Pattern?

    private var textMonitor: NSEventMonitor?

    func startMonitoring() {
        // ç›‘å¬æ–‡æœ¬é€‰æ‹©
        textMonitor = NSEvent.addGlobalMonitorForEvents(matching: .leftMouseUp) { event in
            Task { @MainActor in
                await self.detectTextSelection()
            }
        }

        // ç›‘å¬å‰ªè´´æ¿å˜åŒ–
        NSPasteboard.general.addObserver(self, forKeyPath: "changeCount")
    }

    private func detectTextSelection() async {
        // ä½¿ç”¨ Accessibility API è·å–é€‰ä¸­æ–‡æœ¬
        guard let selectedText = getSelectedText() else { return }

        // æ™ºèƒ½æ¨è Pattern
        let scene = analyzeScene(text: selectedText)
        self.currentScene = scene
        self.recommendedPattern = recommendPattern(for: scene)
    }

    private func analyzeScene(text: String) -> Scene {
        // åœºæ™¯åˆ†æè§„åˆ™
        if text.count > 500 {
            return .longText(text)
        } else if text.contains("@") && text.contains(".") {
            return .email(text)
        } else if text.hasPrefix("http") {
            return .url(text)
        } else {
            return .shortText(text)
        }
    }

    private func recommendPattern(for scene: Scene) -> Pattern {
        switch scene {
        case .longText:
            return .summarize
        case .email:
            return .extract
        case .url:
            return .search
        case .shortText:
            return .translate
        }
    }
}

enum Scene {
    case longText(String)
    case email(String)
    case url(String)
    case shortText(String)
}
```

**éªŒæ”¶**:
- âœ… é€‰æ‹©æ–‡æœ¬åè‡ªåŠ¨æ¨è Pattern
- âœ… å‰ªè´´æ¿å˜åŒ–è§¦å‘åœºæ™¯è¯†åˆ«
- âœ… æ€§èƒ½å¼€é”€ < 5% CPU
- âœ… æ— éšç§æ³„éœ²ï¼ˆæœ¬åœ°å¤„ç†ï¼‰

---

### Day 8-9: æ¸è¿›å¼ä¿¡ä»»æœºåˆ¶

**ä»»åŠ¡**:
- [ ] å®ç° TrustEngineï¼ˆRisk Level 0-3ï¼‰
- [ ] è®¾è®¡é£é™©è¯„ä¼°è§„åˆ™
- [ ] é›†æˆ Policy Engineï¼ˆå¤ç”¨ Phase 1.5ï¼‰
- [ ] UI é£é™©æç¤ºï¼ˆRiskBadgeï¼‰

**äº¤ä»˜ç‰©**: TrustEngine.swift + RiskBadge.swift

**é£é™©ç­‰çº§å®šä¹‰**:
```swift
// RiskLevel.swift
enum RiskLevel: Int, Comparable {
    case r0_safe = 0        // å®‰å…¨ï¼šåªè¯»æ“ä½œ
    case r1_low = 1         // ä½é£é™©ï¼šæ–‡æœ¬å¤„ç†
    case r2_medium = 2      // ä¸­é£é™©ï¼šæ–‡ä»¶è¯»å–
    case r3_high = 3        // é«˜é£é™©ï¼šæ–‡ä»¶å†™å…¥/ç½‘ç»œè¯·æ±‚

    var color: Color {
        switch self {
        case .r0_safe: return .green
        case .r1_low: return .blue
        case .r2_medium: return .orange
        case .r3_high: return .red
        }
    }

    var requiresConfirmation: Bool {
        self >= .r2_medium
    }
}

// TrustEngine.swift
@Observable
class TrustEngine {
    private let policyEngine: PolicyEngine  // Phase 1.5

    func assessRisk(for task: Task) -> RiskLevel {
        var risk: RiskLevel = .r0_safe

        // è§„åˆ™ 1: æ“ä½œç±»å‹
        if task.pattern == .format || task.pattern == .translate {
            risk = .r1_low  // æ–‡æœ¬å¤„ç†
        } else if task.pattern == .search {
            risk = .r3_high  // ç½‘ç»œè¯·æ±‚
        }

        // è§„åˆ™ 2: è¾“å…¥æ¥æº
        if task.source == .file {
            risk = max(risk, .r2_medium)  // æ–‡ä»¶è¯»å–
        }

        // è§„åˆ™ 3: è¾“å‡ºç›®æ ‡
        if task.outputTarget == .file {
            risk = .r3_high  // æ–‡ä»¶å†™å…¥
        }

        // Phase 1.5 Policy Engine éªŒè¯
        if !policyEngine.isAllowed(task) {
            risk = .r3_high
        }

        return risk
    }

    func requestConfirmation(for task: Task) async -> Bool {
        let risk = assessRisk(for: task)
        guard risk.requiresConfirmation else { return true }

        // æ˜¾ç¤ºç¡®è®¤å¯¹è¯æ¡†
        return await showConfirmationDialog(task: task, risk: risk)
    }
}
```

**éªŒæ”¶**:
- âœ… R0-R3 é£é™©è¯„ä¼°å‡†ç¡®
- âœ… R2+ æ“ä½œéœ€è¦ç”¨æˆ·ç¡®è®¤
- âœ… UI é£é™©æ ‡è¯†æ¸…æ™°
- âœ… é›†æˆ Phase 1.5 Policy Engine

---

### Day 10: ä¸€é”®æ’¤é”€ç³»ç»Ÿ

**ä»»åŠ¡**:
- [ ] å®ç° UndoManagerï¼ˆ7 å¤©å†…å¯å›æ»šï¼‰
- [ ] æ–‡ä»¶ç‰ˆæœ¬ç®¡ç†ï¼ˆå¿«ç…§å­˜å‚¨ï¼‰
- [ ] UI æ’¤é”€æŒ‰é’®ä¸å†å²è®°å½•
- [ ] è‡ªåŠ¨æ¸…ç†è¿‡æœŸå¿«ç…§

**äº¤ä»˜ç‰©**: UndoManager.swift + UndoSnapshot.swift

**æ ¸å¿ƒåŠŸèƒ½**:
```swift
// UndoSnapshot.swift
struct UndoSnapshot: Codable, Identifiable {
    let id: UUID
    let taskID: UUID
    let timestamp: Date
    let originalContent: Data
    let modifiedContent: Data
    let filePath: URL?

    var isExpired: Bool {
        Date().timeIntervalSince(timestamp) > 7 * 24 * 3600  // 7 å¤©
    }
}

// UndoManager.swift
actor UndoManager {
    private let snapshotDirectory: URL
    private var snapshots: [UndoSnapshot] = []

    init() {
        self.snapshotDirectory = FileManager.default
            .urls(for: .applicationSupportDirectory, in: .userDomainMask)[0]
            .appendingPathComponent("MacCortex/Snapshots")

        try? FileManager.default.createDirectory(
            at: snapshotDirectory,
            withIntermediateDirectories: true
        )

        // åŠ è½½ç°æœ‰å¿«ç…§
        loadSnapshots()
    }

    func createSnapshot(for task: Task, originalContent: Data) async throws {
        let snapshot = UndoSnapshot(
            id: UUID(),
            taskID: task.id,
            timestamp: Date(),
            originalContent: originalContent,
            modifiedContent: task.result?.data ?? Data(),
            filePath: task.outputTarget == .file ? task.outputURL : nil
        )

        // ä¿å­˜å¿«ç…§åˆ°ç£ç›˜
        try await saveSnapshot(snapshot)
        snapshots.append(snapshot)
    }

    func undo(snapshotID: UUID) async throws {
        guard let snapshot = snapshots.first(where: { $0.id == snapshotID }) else {
            throw UndoError.snapshotNotFound
        }

        // æ¢å¤åŸå§‹å†…å®¹
        if let filePath = snapshot.filePath {
            try snapshot.originalContent.write(to: filePath)
        }

        // åˆ é™¤å¿«ç…§
        try await deleteSnapshot(snapshot)
        snapshots.removeAll { $0.id == snapshotID }
    }

    func cleanupExpiredSnapshots() async {
        let expired = snapshots.filter { $0.isExpired }
        for snapshot in expired {
            try? await deleteSnapshot(snapshot)
        }
        snapshots.removeAll { $0.isExpired }
    }
}
```

**éªŒæ”¶**:
- âœ… æ–‡ä»¶æ“ä½œå‰è‡ªåŠ¨åˆ›å»ºå¿«ç…§
- âœ… 7 å¤©å†…å¯ä¸€é”®å›æ»š
- âœ… è¿‡æœŸå¿«ç…§è‡ªåŠ¨æ¸…ç†
- âœ… å­˜å‚¨å¼€é”€ < 100MBï¼ˆæ­£å¸¸ä½¿ç”¨ï¼‰

---

## Week 3: UI å®Œå–„ + é›†æˆæµ‹è¯•ï¼ˆDay 11-15ï¼‰

### Day 11-12: å†å²è®°å½•ä¸è®¾ç½®

**ä»»åŠ¡**:
- [ ] å®ç° HistoryViewï¼ˆä»»åŠ¡å†å²ï¼‰
- [ ] å®ç° SettingsViewï¼ˆåº”ç”¨è®¾ç½®ï¼‰
- [ ] SwiftData æŒä¹…åŒ–
- [ ] æœç´¢ä¸è¿‡æ»¤åŠŸèƒ½

**äº¤ä»˜ç‰©**: HistoryView.swift + SettingsView.swift

---

### Day 13-14: é›†æˆæµ‹è¯•

**ä»»åŠ¡**:
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•ï¼ˆUI â†’ Backend â†’ å®‰å…¨æ¨¡å—ï¼‰
- [ ] æ€§èƒ½æµ‹è¯•ï¼ˆUI å“åº”æ—¶é—´ < 100msï¼‰
- [ ] æƒé™æµ‹è¯•ï¼ˆFull Disk Accessï¼‰
- [ ] æ’¤é”€ç³»ç»Ÿæµ‹è¯•

**éªŒæ”¶æ ‡å‡†**:
- âœ… æ‰€æœ‰ 5 ä¸ª Pattern æ­£å¸¸å·¥ä½œ
- âœ… Phase 1.5 å®‰å…¨æ¨¡å—é›†æˆæ— è¯¯
- âœ… UI å“åº”æ—¶é—´ < 100ms p95
- âœ… æ’¤é”€æˆåŠŸç‡ 100%

---

### Day 15: æ–‡æ¡£ä¸å‘å¸ƒå‡†å¤‡

**ä»»åŠ¡**:
- [ ] æ›´æ–° README.mdï¼ˆPhase 2 å®Œæˆï¼‰
- [ ] åˆ›å»ºç”¨æˆ·æ‰‹å†Œ
- [ ] ç”Ÿæˆç­¾å DMG
- [ ] å…¬è¯æµ‹è¯•

**äº¤ä»˜ç‰©**: MacCortex-v1.0.dmg

---

## Phase 2 éªŒæ”¶æ ‡å‡†ï¼ˆP0 é˜»å¡æ€§ï¼‰

| # | éªŒæ”¶é¡¹ | æµ‹è¯•æ–¹æ³• | æœŸæœ›ç»“æœ | ä¼˜å…ˆçº§ |
|---|--------|----------|----------|--------|
| 1 | **Desktop GUI å¯ç”¨æ€§** | æ‰‹åŠ¨æµ‹è¯• | æ‰€æœ‰ 5 ä¸ª Pattern æ­£å¸¸å·¥ä½œ | P0 |
| 2 | **åœºæ™¯è¯†åˆ«å‡†ç¡®ç‡** | 100 ä¸ªåœºæ™¯æµ‹è¯• | â‰¥ 85% å‡†ç¡®ç‡ | P0 |
| 3 | **ä¿¡ä»»æœºåˆ¶æœ‰æ•ˆæ€§** | é£é™©è¯„ä¼°æµ‹è¯• | R2+ æ“ä½œéœ€ç¡®è®¤ | P0 |
| 4 | **æ’¤é”€æˆåŠŸç‡** | 50 æ¬¡æ’¤é”€æµ‹è¯• | 100% æˆåŠŸç‡ | P0 |
| 5 | **UI å“åº”æ—¶é—´** | æ€§èƒ½åŸºå‡†æµ‹è¯• | < 100ms p95 | P0 |
| 6 | **Phase 1.5 å®‰å…¨é›†æˆ** | é›†æˆæµ‹è¯• | å®¡è®¡æ—¥å¿—ã€é€Ÿç‡é™åˆ¶æ­£å¸¸ | P0 |

**é€šè¿‡æ¡ä»¶**: æ‰€æœ‰ 6 é¡¹å¿…é¡» âœ…

---

## å…³é”®æŠ€æœ¯å†³ç­–

### å†³ç­– 1: Observation Framework vs Combine

**é—®é¢˜**: SwiftUI çŠ¶æ€ç®¡ç†é€‰æ‹©å“ªç§æ–¹æ¡ˆï¼Ÿ

**é€‰é¡¹**:
- **æ–¹æ¡ˆ A**: Observation Frameworkï¼ˆSwift 5.9+ï¼‰
- **æ–¹æ¡ˆ B**: Combineï¼ˆä¼ ç»Ÿæ–¹æ¡ˆï¼‰
- **æ–¹æ¡ˆ C**: æ··åˆä½¿ç”¨

**å»ºè®®**: **æ–¹æ¡ˆ A** - Observation Framework

**ç†ç”±**:
- macOS 14+ åŸç”Ÿæ”¯æŒï¼Œæ›´ç®€æ´çš„ API
- æ›´å¥½çš„æ€§èƒ½ï¼ˆç¼–è¯‘å™¨ä¼˜åŒ–ï¼‰
- è‡ªåŠ¨ä¾èµ–è¿½è¸ªï¼ˆæ— éœ€æ‰‹åŠ¨ @Publishedï¼‰
- ç¬¦åˆ Apple æœ€æ–°æŠ€æœ¯æ–¹å‘

---

### å†³ç­– 2: æµ®åŠ¨å·¥å…·æ  vs èœå•æ åº”ç”¨

**é—®é¢˜**: ä¸»ç•Œé¢å½¢æ€é€‰æ‹©ï¼Ÿ

**é€‰é¡¹**:
- **æ–¹æ¡ˆ A**: æµ®åŠ¨å·¥å…·æ ï¼ˆApple Intelligence é£æ ¼ï¼‰
- **æ–¹æ¡ˆ B**: èœå•æ åº”ç”¨ï¼ˆRaycast é£æ ¼ï¼‰
- **æ–¹æ¡ˆ C**: ä¼ ç»Ÿçª—å£åº”ç”¨

**å»ºè®®**: **æ–¹æ¡ˆ A** - æµ®åŠ¨å·¥å…·æ 

**ç†ç”±**:
- ç¬¦åˆ"éšå½¢ AI"è®¾è®¡ç†å¿µ
- å¿«æ·é”®è§¦å‘ï¼Œå³ç”¨å³èµ°
- è§†è§‰ä¸Šæ›´ç°ä»£åŒ–
- æ”¯æŒæ‹–æ‹½å®šä½

---

### å†³ç­– 3: SwiftData vs Core Data

**é—®é¢˜**: æŒä¹…åŒ–æ–¹æ¡ˆé€‰æ‹©ï¼Ÿ

**é€‰é¡¹**:
- **æ–¹æ¡ˆ A**: SwiftDataï¼ˆSwift åŸç”Ÿï¼‰
- **æ–¹æ¡ˆ B**: Core Dataï¼ˆObjective-Cï¼‰

**å»ºè®®**: **æ–¹æ¡ˆ A** - SwiftData

**ç†ç”±**:
- macOS 14+ åŸç”Ÿæ”¯æŒ
- Swift åŸç”Ÿ APIï¼Œç±»å‹å®‰å…¨
- è‡ªåŠ¨ç”Ÿæˆ Schema
- ä¸ Observation Framework æ— ç¼é›†æˆ

---

## é£é™©ä¸ç¼“è§£

| é£é™© | æ¦‚ç‡ | å½±å“ | ç¼“è§£ç­–ç•¥ | æ®‹ä½™é£é™© |
|------|------|------|----------|----------|
| **Accessibility API æƒé™è¢«æ‹’** | 20% | é«˜ | ä¼˜é›…é™çº§ï¼ˆæ‰‹åŠ¨è§¦å‘ï¼‰ | ğŸŸ¡ ä¸­ |
| **æ€§èƒ½ä¸è¾¾æ ‡** | 15% | ä¸­ | å¼‚æ­¥å¤„ç† + ç¼“å­˜ | ğŸŸ¢ ä½ |
| **æ’¤é”€å¤±è´¥** | 10% | é«˜ | å®Œæ•´æµ‹è¯• + äº‹åŠ¡æœºåˆ¶ | ğŸŸ¢ ä½ |
| **åœºæ™¯è¯†åˆ«è¯¯æŠ¥** | 30% | ä½ | æ‰‹åŠ¨é€‰æ‹© Pattern | ğŸŸ¢ ä½ |
| **Backend è¿æ¥å¤±è´¥** | 5% | é«˜ | ç¦»çº¿æ¨¡å¼ + é”™è¯¯æç¤º | ğŸŸ¢ ä½ |

**æ€»ä½“é£é™©è¯„åˆ†**: ğŸŸ¢ **å¯æ§**

---

## ä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼ˆç«‹å³æ‰§è¡Œï¼‰

### Day 1 ç«‹å³å¼€å§‹

```bash
# 1. åˆ›å»º Xcode é¡¹ç›®
cd /Users/jamesg/projects/MacCortex
xcodebuild -project MacCortex.xcodeproj -list

# å¦‚æœé¡¹ç›®ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ–°é¡¹ç›®
# ï¼ˆéœ€è¦åœ¨ Xcode ä¸­æ‰‹åŠ¨åˆ›å»ºï¼‰

# 2. éªŒè¯ Phase 1.5 Backend è¿è¡Œæ­£å¸¸
cd Backend && source .venv/bin/activate
python -m uvicorn src.main:app --reload &

# 3. æµ‹è¯• API è¿æ¥
curl -X POST http://localhost:8000/execute -d '{
  "pattern_id": "summarize",
  "text": "Phase 2 å¯åŠ¨æµ‹è¯•",
  "parameters": {"length": "short"}
}'

# 4. æŸ¥çœ‹ Phase 1.5 å®¡è®¡æ—¥å¿—
cat Backend/logs/audit-$(date +%Y-%m-%d).jsonl | jq .
```

---

**è®¡åˆ’çŠ¶æ€**: â³ å¾…æ‰¹å‡†
**åˆ›å»ºæ—¶é—´**: 2026-01-21
**åŸºäº**: Phase 1.5 å®ŒæˆçŠ¶æ€ + README_ARCH.md v1.1
**æ‰§è¡Œäºº**: Claude Code (Sonnet 4.5)
**éªŒè¯æ–¹å¼**: 6 é¡¹ P0 éªŒæ”¶æ ‡å‡†
